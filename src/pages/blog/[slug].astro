---
import { Partial, SVG } from '@splendidlabz/astro'
import { processFiles } from '@splendidlabz/astro/content'
import { ContentList } from '@splendidlabz/svelte'
import { getCollection, render } from 'astro:content'
// import Freebie from '/src/components/Freebie.astro'
import { Markdown } from '@splendidlabz/astro'
// import PostNav from '/src/components/PostNav.astro'
import { formatDate } from 'date-fns'
import PrevNextNav from '/src/components/PrevNextNav.astro'
import Base from '/src/layouts/Base.astro'

// For Components
import { Image, Video } from '@splendidlabz/astro'
import Button from '/src/components/legacy/Button.svelte'
import Callout from '/src/components/legacy/Callout.svelte'
import Codepen from '/src/components/legacy/Codepen.astro'
import Tweet from '/src/components/legacy/Tweet.astro'
import Youtube from '/src/components/legacy/Youtube.svelte'

const components = { Image, Video, Youtube, Codepen, Button, Callout, Tweet }

export const prerender = true

export async function getStaticPaths() {
  const files = await getCollection('blog')
  const posts = await processFiles(files)

  return posts.map((post, index) => {
    return {
      params: { slug: post.data.slug },
      props: {
        posts: {
          current: post,
          prev: posts[index + 1],
          next: posts[index - 1],
        },
      },
    }
  })
}

const { posts } = Astro.props
const { current: post } = posts
const { Content } = await render(post)

const dateText =
  post.data.updateDate && post.data.updateDate < Date.now()
    ? 'Updated'
    : 'Published'
---

<Base {...post.data}>
  <div class="wrap">
    <article class="article grid-fr-auto mx-auto max-w-[calc(33rlh+10rlh)]">
      <header>
        <div class="meta">
          <div class="text-zgray-500">
            {dateText} on
            {formatDate(post.data.date, 'MMM d, yyyy')}
          </div>

          <div class="tags text-zgray-500">
            <span>Filed under:</span>
            {
              post.data.tags.map((tag, index) => (
                <>
                  <a
                    class="pigment-gray-text underline"
                    href={`/tags/${tag.toLowerCase()}`}
                  >
                    #{tag.toLowerCase()}
                  </a>
                  {index !== post.data.tags.length - 1 && <span>, </span>}
                </>
              ))
            }
          </div>
        </div>
        <hgroup>
          <h1 class="h1"><Markdown inline>{post.data.title} </Markdown></h1>
        </hgroup>
      </header>

      <div></div>

      <div id="content" class="content prose">
        <Content {components} />
      </div>

      <div class="w-[10rlh] max-w-full">
        <ContentList
          class="content-list sticky top-4"
          label="On This Page"
          selector="#content"
          listClass="indentlist"
          client:idle
        />
      </div>

      <div class="[--span:2]">
        <PrevNextNav prev={posts.prev} next={posts.next} />
      </div>
    </article>
  </div>

  <div class="mt-section">
    <SVG class="rotate-180 simple-svg stroke-zred-500" icon="wriggle-line" />
  </div>
  <Partial path="JoinMyNewsletter" />
</Base>
